<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TV Mundial con Banderas y Reproductor Popup</title>
  <link href="https://cdn.jsdelivr.net/npm/video.js@8.9.0/dist/video-js.min.css" rel="stylesheet" />
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #000;
      color: #fff;
      display: flex;
      height: 100vh;
      overflow: hidden;
      flex-direction: row;
    }
    #map-container {
      flex: 1;
      background: #111;
      display: flex;
      flex-wrap: wrap;
      align-content: flex-start;
      padding: 20px;
      overflow-y: auto;
      gap: 10px;
      justify-content: center;
      align-items: center;
    }
    .country-flag {
      width: 60px;
      height: 40px;
      border: 2px solid transparent;
      border-radius: 6px;
      cursor: pointer;
      transition: border-color 0.3s;
      box-shadow: 0 0 8px rgba(0,0,0,0.5);
    }
    .country-flag:hover {
      border-color: #0080ff;
      box-shadow: 0 0 15px #0080ff;
    }
    .country-flag.selected {
      border-color: #00f;
      box-shadow: 0 0 20px #00f;
    }
    #sidebar {
      width: 350px;
      background: #222;
      display: flex;
      flex-direction: column;
      padding: 10px;
      overflow-y: auto;
      border-left: 1px solid #333;
    }
    #sidebar h2 {
      margin: 0 0 10px 0;
      font-size: 1.3rem;
      border-bottom: 1px solid #444;
      padding-bottom: 5px;
      text-align: center;
    }
    #channelSearch {
      padding: 8px;
      border-radius: 5px;
      border: none;
      font-size: 1rem;
      outline: none;
      margin-bottom: 10px;
      width: 100%;
      box-sizing: border-box;
      color: #000;
    }
    #channelsList {
      flex: 1;
      overflow-y: auto;
    }
    .channel {
      padding: 6px 8px;
      cursor: pointer;
      border-radius: 4px;
      margin: 3px 0;
      background: #333;
    }
    .channel:hover {
      background: #555;
    }
    .selectedChannel {
      background: #0080ff !important;
      color: #fff;
    }
    .loading {
      color: #888;
      font-style: italic;
      padding: 10px;
    }

    /* Modal reproductor grande */
    #playerModal {
      display: none;
      position: fixed;
      z-index: 9999;
      left: 0; top: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.85);
      justify-content: center;
      align-items: center;
    }
    #playerModal.active {
      display: flex;
    }
    #playerContainer {
      background: #111;
      border-radius: 8px;
      padding: 10px;
      max-width: 90vw;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 0 20px #0080ff;
      position: relative;
    }
    #closePlayer {
      position: absolute;
      top: 5px;
      right: 10px;
      color: #fff;
      font-size: 2rem;
      cursor: pointer;
      user-select: none;
      font-weight: bold;
      z-index: 10000;
    }
    video-js {
      max-width: 100%;
      max-height: 80vh;
      border-radius: 6px;
    }

    @media (max-width: 768px) {
      body {
        flex-direction: column;
      }
      #sidebar {
        width: 100%;
        height: 300px;
        border-left: none;
        border-top: 1px solid #333;
      }
      #map-container {
        flex: none;
        height: calc(100vh - 300px);
        overflow-y: scroll;
      }
      #playerContainer {
        max-height: 70vh;
      }
    }
  </style>
</head>
<body>
  <div id="map-container" aria-label="Selector de países con banderas" role="list">
    <!-- Las banderas se cargan con JS -->
  </div>

  <div id="sidebar" aria-live="polite">
    <h2 id="countryTitle">Selecciona un país</h2>
    <input type="text" id="channelSearch" placeholder="Buscar canales..." disabled aria-label="Buscar canales" />
    <div id="channelsList"><em>Los canales aparecerán aquí al seleccionar un país.</em></div>
  </div>

  <div id="playerModal" role="dialog" aria-modal="true" aria-labelledby="playerTitle">
    <div id="playerContainer">
      <div id="closePlayer" role="button" aria-label="Cerrar reproductor" tabindex="0">&times;</div>
      <h2 id="playerTitle" style="color:#ddd; text-align:center; margin:0 0 10px 0;">Reproductor</h2>
      <video-js
        id="tv"
        class="video-js vjs-default-skin"
        controls
        preload="auto"
        width="800"
        height="450"
        data-setup="{}"
      >
        <source src="" type="application/x-mpegURL" />
        Tu navegador no soporta video.
      </video-js>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/video.js@8.9.0/dist/video.min.js"></script>
  <script>
    const countries = [
      { code: 'us', name: 'Estados Unidos' },
      { code: 'mx', name: 'México' },
      { code: 'ca', name: 'Canadá' },
      { code: 'es', name: 'España' },
      { code: 'fr', name: 'Francia' },
      { code: 'de', name: 'Alemania' },
      { code: 'ar', name: 'Argentina' },
      { code: 'br', name: 'Brasil' },
      { code: 'au', name: 'Australia' },
    ];

    const mapContainer = document.getElementById('map-container');
    const channelSearchEl = document.getElementById('channelSearch');
    const channelsListEl = document.getElementById('channelsList');
    const countryTitleEl = document.getElementById('countryTitle');

    const playerModal = document.getElementById('playerModal');
    const closePlayerBtn = document.getElementById('closePlayer');
    const player = videojs('tv');

    let loadedChannelsByCountry = {};
    let currentCountryCode = null;
    let currentSelectedChannelDiv = null;

    // Carga las banderas en el "mapa"
    function loadFlags() {
      countries.forEach(c => {
        const img = document.createElement('img');
        img.src = `https://flagcdn.com/w80/${c.code}.png`;
        img.alt = c.name;
        img.title = c.name;
        img.className = 'country-flag';
        img.setAttribute('role', 'listitem');
        img.tabIndex = 0;
        img.addEventListener('click', () => selectCountry(c.code));
        img.addEventListener('keydown', e => {
          if(e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            selectCountry(c.code);
          }
        });
        mapContainer.appendChild(img);
      });
    }

    // Parsea el archivo M3U
    function parseM3U(text) {
      const lines = text.split(/\r?\n/);
      const result = [];
      for (let i = 0; i < lines.length; i++) {
        if (lines[i].startsWith('#EXTINF')) {
          let name = lines[i].split(',')[1] || 'Sin nombre';
          const idx = name.indexOf(' group-title=');
          if (idx !== -1) name = name.substring(0, idx).trim();
          const url = lines[i + 1];
          result.push({ name, url });
          i++;
        }
      }
      return result;
    }

    // Muestra los canales en la lista lateral
    function showChannels(channels) {
      channelsListEl.innerHTML = '';
      if (channels.length === 0) {
        channelsListEl.innerHTML = '<em>No hay canales para mostrar.</em>';
        return;
      }
      channels.forEach(ch => {
        const chDiv = document.createElement('div');
        chDiv.className = 'channel';
        chDiv.textContent = ch.name;
        chDiv.title = ch.name;
        chDiv.tabIndex = 0;
        chDiv.onclick = () => playChannel(ch, chDiv);
        chDiv.onkeydown = (e) => {
          if(e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            playChannel(ch, chDiv);
          }
        }
        channelsListEl.appendChild(chDiv);
      });
    }

    // Limpia selección de canal
    function clearChannelSelection() {
      if(currentSelectedChannelDiv) {
        currentSelectedChannelDiv.classList.remove('selectedChannel');
        currentSelectedChannelDiv = null;
      }
    }

    // Reproduce canal y abre modal
    function playChannel(channel, div) {
      player.src({ type: 'application/x-mpegURL', src: channel.url });
      player.play();
      clearChannelSelection();
      div.classList.add('selectedChannel');
      currentSelectedChannelDiv = div;
      countryTitleEl.textContent = `Canales de ${getCountryName(currentCountryCode)} - Reproduciendo: ${channel.name}`;
      openPlayerModal();
    }

    // Abrir modal reproductor
    function openPlayerModal() {
      playerModal.classList.add('active');
      // Focus al video
      setTimeout(() => {
        player.tech(true).el().focus();
      }, 300);
    }
    // Cerrar modal reproductor
    function closePlayerModal() {
      playerModal.classList.remove('active');
      player.pause();
    }

    // Buscar nombre país
    function getCountryName(code) {
      const c = countries.find(c => c.code === code);
      return c ? c.name : '';
    }

    // Cargar canales de un país
    async function selectCountry(code) {
      if(currentCountryCode === code) return;
      currentCountryCode = code;
      countryTitleEl.textContent = `Canales de ${getCountryName(code)}`;
      channelSearchEl.value = '';
      channelSearchEl.disabled = false;
      clearChannelSelection();
      highlightSelectedFlag(code);

      if(loadedChannelsByCountry[code]) {
        showChannels(loadedChannelsByCountry[code]);
      } else {
        channelsListEl.innerHTML = '<div class="loading">Cargando canales...</div>';
        try {
          const res = await fetch(`https://iptv-org.github.io/iptv/countries/${code}.m3u`);
          if(!res.ok) throw new Error('No se pudo cargar el archivo');
          const text = await res.text();
          const channels = parseM3U(text);
          loadedChannelsByCountry[code] = channels;
          showChannels(channels);
        } catch (e) {
          channelsListEl.innerHTML = '<em>Error cargando canales.</em>';
          console.error(e);
        }
      }
    }

    // Resalta la bandera seleccionada
    function highlightSelectedFlag(code) {
      document.querySelectorAll('.country-flag').forEach(img => {
        if(img.src.includes(`/${code}.png`)) {
          img.classList.add('selected');
        } else {
          img.classList.remove('selected');
        }
      });
    }

    // Filtrar canales en la lista
    channelSearchEl.addEventListener('input', () => {
      const search = channelSearchEl.value.trim().toLowerCase();
      if (!currentCountryCode) return;
      if (!search) {
        showChannels(loadedChannelsByCountry[currentCountryCode] || []);
        return;
      }
      const filtered = (loadedChannelsByCountry[currentCountryCode] || []).filter(ch =>
        ch.name.toLowerCase().includes(search)
      );
      showChannels(filtered);
    });

    // Cerrar modal con botón y tecla ESC
    closePlayerBtn.addEventListener('click', closePlayerModal);
    window.addEventListener('keydown', e => {
      if(e.key === 'Escape' && playerModal.classList.contains('active')) {
        closePlayerModal();
      }
    });

    // Inicia el mapa con
